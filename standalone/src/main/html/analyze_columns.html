<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DATA ANALYSIS RESULTS</title>
  <script src="js/jquery-1.10.2.js"></script>
  <script src="js/jquery-ui.js"></script>
  <link rel="stylesheet" href="css/jquery-ui.css"/>
<style>
#container
{
width: 90%;
margin: 10px auto;
background-color: #fff;
color: #333;
border: 1px solid gray;
line-height: 130%;
}

#top
{
padding: .5em;
background-color: #ddd;
border-bottom: 1px solid gray;
}

#top h1
{
padding: 0;
margin: 0;
}

#leftnav
{
float: left;
//width: 160px;
//width: 60%;
margin: 0;
padding: 1em;
}

/*#content
{
margin-left: 65%;
border-left: 1px solid gray;
padding: 1em;
//max-width: 36em;
}*/

#footer
{
clear: both;
margin: 0;
padding: .5em;
color: #333;
background-color: #ddd;
border-top: 1px solid gray;
}

#leftnav p { margin: 0 0 1em 0; }
//#content h2 { margin: 0 0 .5em 0; }

.d_table,.d_tr, .d_td {
    width: 100%;
    border: 0px;
}

table, td, th {
    border: 1px solid gray;
    padding: .2em;
}

th {
    background-color: gray;
    color: white;
}
table {
    border-collapse: collapse;
}


</style>
<script>

  function showDetail(columnIndex, typeSummaryIndex) {
    var column = columns[columnIndex]
    var columnSummary = column.typeSummaries[typeSummaryIndex]
    var content = "<h3>Column: " + column.column + "<br>Type: " + columnSummary.type + "</h3>"
    content += "<div id=\"accordian\">"
    // Summary statistics
    content += "<h3>Summary Statistics</h3>"
    content += "<div><p><table class=\"dt\">"
    content += "<tr><td>Count</td><td>" + columnSummary.numValues+ "</td></tr>"
    content += "<tr><td>Distinct Count</td><td>" + columnSummary.numUniqueValues + "</td></tr>"
    if(columnSummary.quantiles != null)
    {
        for (var property in columnSummary.quantiles) {
          if (columnSummary.quantiles.hasOwnProperty(property)) {
            content += "<tr><td>" + property + ((property == "min" || property == "max")?"":" Percentile") + "</td>"
            content += "<td>" + columnSummary.quantiles[property] + "</td></tr>"
          }
        }

    }
    content += "</table>"
    content += "</div>"
    if(columnSummary.sample != null)
    {
      content += "<h3>Data Sample</h3>"
      content += "<div><p><ul>"
      for(var i = 0;i < columnSummary.sample.length && i < 10;++i)
      {
        content += "<li>" + columnSummary.sample[i] + "</li>"
      }
      content += "</ul>"
      content += "</div>"
    }
    
    if(columnSummary.canonicalizedRepresentations != null) {
      content += "<h3>Canonical Representation</h3>"
      content += "<div><p><ul>"
      for(var i = 0;i < columnSummary.canonicalizedRepresentations.length;++i)
      {
        content += "<li>" + columnSummary.canonicalizedRepresentations[i] + "</li>"
      }
      content += "</ul>"
      content += "</div>"

    }
    content += "</div>" 
    $("#content").empty()
    $("#content").append(content)
    $(function() {
      $( "#content" ).dialog(
          {
            width: 800,
            height: 500
          }
                            );
    });
    }

  function writeTable() {
    var content = "<table ><tr><th>Column</th><th>Predicted Type</th><th>Distinct Count</th><th>Type Distribution</th></tr>";
    for(i = 0;i < columns.length;++i) {
      content += "<tr>" 
      + "<td class=\"export\">" + columns[i].column + "</td>"
      + "<td class=\"export\">" + columns[i].predictedType+ "</td>";
      var distribution = "<table class=\"d_table\">"
      var distinctCount = 0
      for(var j = 0;j < columns[i].typeSummaries.length;++j) {
        distinctCount += columns[i].typeSummaries[j].numUniqueValues
      }
      content += "<td class=\"export\">" + distinctCount + "</td>"
      for (var property in columns[i].typeDistribution) {
        if (columns[i].typeDistribution.hasOwnProperty(property)) {
          var columnIndex = i
          var summaryIndex = -1 
          for(var j = 0;j < columns[i].typeSummaries.length;++j) {
            if(columns[i].typeSummaries[j].type == property)
            {
              summaryIndex = j
              break
            }
          }
          distribution += "<tr class=\"d_tr\"><td class=\"d_td\"><a href=\"#!\" onclick=\"showDetail(" + columnIndex + "," + summaryIndex + ")\">" + property + "</a></td>"
          distribution += "<td class=\"d_td\">" + columns[i].typeDistribution[property] + "</td>"
        }
      }
      distribution += "</table>"
      content += "<td>" + distribution + "</td></tr>"
    }
    content += "</table>"
    $("#data_table").empty()
    $("#data_table").append(content)
  }
$(document).ready(function () {

    function exportTableToCSV($table, filename) {

        var $rows = $table.find('tr:has(td)'),

            // Temporary delimiter characters unlikely to be typed by keyboard
            // This is to avoid accidentally splitting the actual contents
            tmpColDelim = String.fromCharCode(11), // vertical tab character
            tmpRowDelim = String.fromCharCode(0), // null character

            // actual delimiter characters for CSV format
            colDelim = ',',
            rowDelim = '\r\n',

            // Grab text from table into CSV formatted string
            csv = '' + $rows.map(function (i, row) {
                var $row = $(row),
                    $cols = $row.find('.export');

                return $cols.map(function (j, col) {
                    var $col = $(col),
                        text = $col.text();

                    return text.replace(/"/g, '""'); // escape double quotes

                }).get().join(tmpColDelim);

            }).get().join(tmpRowDelim)
                .split(tmpRowDelim).filter(function(obj) { return obj != ''}).join(rowDelim)
                .split(tmpColDelim).join(colDelim) + '',

            // Data URI
            csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

        $(this)
            .attr({
            'download': filename,
                'href': csvData,
                'target': '_blank'
        });
    }

    // This must be a hyperlink
    $(".export").on('click', function (event) {
        // CSV
        exportTableToCSV.apply(this, [$('#data_table>table'), 'export.csv']);
        
        // IF CSV, don't do event.preventDefault() or return false
        // We actually need this to be a typical hyperlink
    });
    $(function() {
      //$( "#tabs" ).tabs();
    });

}); 
</script>
</head>
<body>
<h1><span style="color:red;">C</span>asey's <span style="color:red;">D</span>ata <span style="color:red;">A</span>nalysis <span style="color:red;">T</span>ool</h1>
<div id="tabs">
  <ul>
    <li><a href="#syntactic">Syntactic</a></li>
    <li><a href="#semantic">Semantic</a></li>
  </ul>
  <div id="syntactic">
    <div id="container">
      <div id="top">
        <h2>Choose data file to load: <input type="file" id="files" name="files[]" multiple />
          <a href="#" class="export">Export to CSV</a>
        </h2>
        <script>
function handleFileSelect(evt) {
  var files = evt.target.files; // FileList object

  // files is a FileList of File objects. List some properties.
  var output = [];
  for (var i = 0, f; f = files[i]; i++) {
    if (!f.type.match('json.*')) {
      continue;
    }
    var reader = new FileReader();
    // Closure to capture the file information.
    reader.onload = (function(theFile) {
      return function(e) {
        eval(e.target.result)
        writeTable()
      };
    })(f);
    reader.readAsText(f);
  }
}

document.getElementById('files').addEventListener('change', handleFileSelect, false);


        </script> 


      </div> <!-- end top -->
      <div id="leftnav">
        <h3>Columns</h3>
        <div id="data_table">
          Specify a file and this will be populated.
        </div>
      </div><!-- end leftnav -->
      <div id="content" title="Column Detail">
      </div><!-- end content -->
    </div> <!-- end container -->
  </div> <!-- end syntactic tab-->
  <div id="semantic">
  </div> <!-- end semantic tab -->
  </div><!-- end  tabs -->
  <div id="footer">
Keep on Hadoopin'! :)
  </div>
</body>
</html>
